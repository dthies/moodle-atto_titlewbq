YUI.add("moodle-atto_titlewbq-button",function(e,t){var n="atto_titlewbq",r=[{text:"h3",callbackArgs:"<h3>"},{text:"h4",callbackArgs:"<h4>"},{text:"h5",callbackArgs:"<h5>"},{text:"pre",callbackArgs:"<pre>"},{text:"p",callbackArgs:"<p>"},{text:"blockquote",callbackArgs:"<blockquote>"}];e.namespace("M.atto_titlewbq").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{initializer:function(){var t=[];e.Array.each(r,function(e){t.push({text:M.util.get_string(e.text,e.text==="blockquote"?n:"atto_title"),callbackArgs:e.callbackArgs})}),this.addToolbarMenu({icon:"e/styleprops",globalItemConfig:{callback:this._changeStyle},items:t}),this.setupEscapeBlockquote()},_changeStyle:function(e,t){t==="<blockquote>"?document.execCommand("indent",!1,t):(this.safeOutdent(),document.execCommand("formatBlock",!1,t)),this.markUpdated()},setupEscapeBlockquote:function(){return this.editor.on("key",function(t){function o(t){if(!t.previousSibling){var r=t.parentNode;return e.one(r).test(n)?"":o(r)}return t.previousSibling.tagName&&t.previousSibling.tagName.toLowerCase()==="br"?"":t.previousSibling.textContent||o(t.previousSibling)}var n=this.get("host").BLOCK_TAGS.join(", "),r=window.rangy.getSelection();if(!r.isCollapsed||!r.anchorNode.tagName&&r.anchorOffset)return;if(!e.one(r.anchorNode).ancestor("blockquote",!0)){var i=e.one(r.anchorNode).ancestor("div.editor_atto_content >",!0);(i&&i.previous()&&i.previous().test("blockquote")||this.editor.compareTo(r.anchorNode)&&r.anchorNode.childNodes.item(r.anchorOffset-1))&&document.execCommand("indent",!1,null);return}var s="";if(r.anchorOffset!==0)r.anchorNode.hasChildNodes()?s=o(r.anchorNode.childNodes.item(r.anchorOffset)):s=r.anchorNode.textContent.slice(0,r.anchorOffset-1);else if(!e.one(r.anchorNode).compareTo(r.anchorNode)||!e.one(r.anchorNode).test(n))s=o(r.anchorNode);if(s.replace(/.*\n/,""))return;t.preventDefault(),this.safeOutdent()},"backspace",this),this},safeOutdent:function(){this.editor.all("blockquote").removeAttribute("style"),this.editor.all("blockquote").removeAttribute("class"),this.divideBlockquotes(),document.execCommand("outdent",!1,null),this.mergeBlockquotes()},divideBlockquotes:function(){var t=window.rangy.saveSelection();this.editor.all(".rangySelectionBoundary").setStyle("display",null);var n=e.one(this.get("host").getSelectionParentNode()).ancestor("blockquote",!0)||e.one(this.get("host").getSelectionParentNode());n.all("blockquote").each(function(e){var t=e.getDOMNode().childNodes;for(var n=t.length;n>0;n--){var r=t[n-1];(!r.tagName||r.tagName.toLowerCase()==="#text")&&/^\s*$/.test(r.nodeValue)&&r.remove()}e.addClass("atto-merge-blockquote");while(t.length>1){var i=e.cloneNode(!1);e.ancestor().insertBefore(i,e),i.append(t[0])}}),window.rangy.restoreSelection(t)},mergeBlockquotes:function(){var t=window.rangy.saveSelection();this.editor.all(".rangySelectionBoundary").setStyle("display",null),this.editor.all("blockquote.atto-merge-blockquote").each(function(t){var n=t.getDOMNode().nextSibling;while(n&&n.tagName&&n.tagName.toLowerCase()==="blockquote"&&e.one(n).test(".atto-merge-blockquote")){var r=n.childNodes;while(r.length>0)t.append(r[0]);e.one(n).remove(),n=t.getDOMNode().nextSibling}}),this.editor.all('blockquote[class="atto-merge-blockquote"]').removeAttribute("class"),this.editor.all(".atto-merge-blockquote").removeClass("atto-merge-blockquote"),window.rangy.restoreSelection(t)}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
